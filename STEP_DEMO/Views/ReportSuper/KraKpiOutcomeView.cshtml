@model List<KraKpiOutcomeModel>

<head>
    <link rel="stylesheet" type="text/css" href="~/Content/css/CustomStyles.css">
</head>

<a href="@Url.Action("ViewEmpList", "DeptHead")" class="btn btn-primary" style="text-decoration: none;">
    <span>Search Again</span>
</a>
<br />
<br />
<br />
<div class="dropdown-container">
    <label class="dropdown-label" for="taxPeriodDropdownMV">Choose Session:</label>
    <br />
    <select id="taxPeriodDropdownMV" class="form-control custom-select">
        @foreach (var taxPeriod in ViewBag.TopTaxPeriods)
        {
            <option value="@taxPeriod">@taxPeriod</option>
        }
    </select>
</div>
<br />

<div>
    <p><strong>Employee Code: @ViewBag.EmployeeCode</strong></p>
    <p><strong>Employee Name: @ViewBag.EmployeeName</strong></p>
</div>
<br />

@if (Model != null && Model.Count > 0)
{
    <div class="table-responsive">
        <form method="post" action="@Url.Action("UpdateMarks", "ReportSuper")">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>KRA</th>
                        <th>KPI</th>
                        <th>Outcome</th>
                        <th>Performance Marks</th>
                        <th>Average</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var kraGroup in Model.GroupBy(item => item.KRA))
                    {
                        var kra = kraGroup.Key;
                        var kpis = kraGroup.ToList();
                        var rowCount = kpis.Count;
                        var first = true;

                        foreach (var item in kpis)
                        {
                            <tr>
                                @if (first)
                                {
                                    <td rowspan="@kpis.Count">@kra</td>

                                }
                                <td>@item.KPI</td>
                                <td>@item.Outcome</td>
                                <td>
                                    <select class="marks-select" data-kra="@kra" data-outcome="@item.Outcome">
                                        <option value="">Select Marks</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </td>

                                @if (first)
                                {
                                    <td rowspan="@kpis.Count">
                                        <input type="text" class="average-input" data-kra="@kra" data-outcome="@item.Outcome" readonly />
                                    </td>
                                    first = false;
                                }

                            </tr>

                            

                        }

                    }

                </tbody>
            </table>
            <input type="submit" value="Save Marks" />
        </form>
    </div>
}
else
{
    <div class="alert alert-danger" role="alert">
        No data found!
    </div>
}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

@section scripts {
    <script>
        $(document).ready(function () {
            var kraAverages = {};
            $(".marks-select").on("change", function () {
                var kra = $(this).data("kra");
                var outcome = $(this).data("outcome");
                var selectedValue = parseInt($(this).val());

                console.log("KRA:", kra);
                console.log("Outcome:", outcome);
                console.log("Selected Value:", selectedValue);

                calculateAverage(kra);
            });

            function calculateAverage(kra) {
                var totalMarks = 0;
                var rowCount = 0;

                $(".marks-select[data-kra='" + kra + "']").each(function () {
                    var marks = parseInt($(this).val());
                    if (!isNaN(marks)) {
                        totalMarks += marks;
                        rowCount++;
                    }
                });

                if (rowCount > 0) {
                    var average = totalMarks / rowCount;
                    console.log("Average for KRA " + kra + ": " + average.toFixed(2));

                    kraAverages[kra] = average;

                    $(".average-input[data-kra='" + kra + "']").val(average.toFixed(2));
                }
            }
        });

        // filter data function
        $(function () {
            $('#taxPeriodDropdownMV').change(function () {
                var selectedSession = $(this).val();

                $.ajax({
                    url: '@Url.Action("GetFilteredMarksData", "Home")',
                    type: 'GET',
                    data: { selectedSession: selectedSession },
                    success: function (response) {
                        $('tbody').empty();

                        response.forEach(function (item) {
                            var newRow = '<tr>' +
                                '<td>' + item.KPI_OUTCOME + '</td>' +
                                '<td>' + item.Marks_Achieved + '</td>' +
                                '<td></td>' +
                                '</tr>';

                            $('tbody').append(newRow);
                        });

                        if (response.length > 0) {
                            $('table thead').show();
                        } else {
                            $('table thead').hide();
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                    }
                });
            });
        });
    </script>
}
