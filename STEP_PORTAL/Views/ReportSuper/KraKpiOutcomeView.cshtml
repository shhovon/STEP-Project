@*@model List<KraKpiOutcomeModel>*@
@model DisplayAllDataViewModel

@{
    var firstItem = Model.KraKpiOutcomeData.FirstOrDefault();
    decimal averageKpiAvg = 0;
    if (Model != null && Model.KraKpiOutcomeData.Any())
    {
        averageKpiAvg = Model.KraKpiOutcomeData.Average(m => m.KPI_AVG ?? 0);
    }
}

@{
    var marksUpdateModel = new List<KraKpiOutcomeModel>();
}



<head>
    <link rel="stylesheet" type="text/css" href="~/Content/css/CustomStyles.css">
</head>


<a href="@Url.Action("ViewEmpListRS", "DeptHead")" class="btn btn-primary" style="text-decoration: none;">
    <span>Search Again</span>
</a>
<br />
<br />
<br />

<style>
    .tab {
        display: inline-block;
        margin-left: 40px;
    }

    .tab2 {
        display: inline-block;
        margin-left: 45px;
    }

    .tab3 {
        display: inline-block;
        margin-left: 66px;
    }
</style>

@if (ViewBag.SuccessMessage != null)
{
    <div class="alert alert-success">
        @ViewBag.SuccessMessage
    </div>
}


@if (firstItem != null)
{
    <div>
        <p><strong>Employee Code: <span class="tab2"></span> @Model.EmployeeInfo.EmployeeCode</strong></p>
        <p><strong>Employee Name: <span class="tab"></span> @Model.EmployeeInfo.Name</strong></p>
        <p><strong>Designation: <span class="tab3"></span> @Model.EmployeeInfo.Designation</strong></p>
    </div>
}


@*next year data*@

@if (Model != null && Model.NextYearKraKpiOutcomeData.Count > 0)
{
    <div>
        <button id="toggleButtonNY" class="btn btn-primary" onclick="toggleTableNY()">View Next Year Data</button>
        <div id="tableContainerNY" style="display: none;">
            <table class="user-info-table">
                <thead>
                    <tr>
                        <th>Next Year's KRA</th>
                        <th>Next Year's KPI</th>
                        <th>Completion Deadline</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.NextYearGroupedData)
                    {
                        var kpiCount = item.KPIIs.Count;
                        for (var i = 0; i < kpiCount; i++)
                        {
                            var kpi = item.KPIIs[i];

                            <tr>
                                @if (i == 0)
                                {
                                    <td rowspan=@kpiCount>@item.KRA</td>
                                }
                                <td>@kpi</td>

                                @if (i == 0 && item.Durations != null && item.Durations.Count > 0)
                                {
                                    <td rowspan=@kpiCount>@(item.Durations.First().Value.Date.ToString("dd-MM-yyyy"))</td>
                                }
                                else
                                {
                                    <td rowspan=@kpiCount></td>
                                }
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
}
else
{
    <div class="alert alert-danger" role="alert">
        <i class="fas fa-info-circle"></i>The employee has not yet submitted Next Year's data
    </div>
}

<button id="revertEmployeeButton" class="btn btn-primary" data-regid="@ViewBag.RegId">Revert Employee</button>
<br />
<br />

@if (Model != null && Model.KraKpiOutcomeData.Count > 0)
{
    <div class="table-responsive">
        @using (Html.BeginForm("UpdateMarks", "ReportSuper", new { regId = ViewBag.RegId }, FormMethod.Post))
        {
            <input type="hidden" id="regId" name="regId" value="@ViewBag.RegId" />

            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>KRA</th>
                        <th>KPI</th>
                        <th>Outcome</th>
                        <th>Remarks</th>
                        <th>Performance Marks</th>
                        <th>Average</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.KraKpiOutcomeData.Count;)
                    {
                        var kra = Model.KraKpiOutcomeData[i].KRA;
                        var kraCount = Model.KraKpiOutcomeData.Count(m => m.KRA == kra);
                        for (int j = 0; j < kraCount; j++)
                        {
                            var marksModel = new KraKpiOutcomeModel
                            {
                                Outcome = Model.KraKpiOutcomeData[i].Outcome,
                                Marks = 0
                            };
                            marksUpdateModel.Add(marksModel);

                            <tr>
                                @if (j == 0)
                                {
                                    <td rowspan="@kraCount">@Model.KraKpiOutcomeData[i].KRA</td>
                                }
                                <td>@Model.KraKpiOutcomeData[i].KPI</td>
                                <td>@Model.KraKpiOutcomeData[i].Outcome</td>
                                <td>
                                    <input type="text" name="model[@i].Remarks" value="@Model.KraKpiOutcomeData[i].Remarks" />
                                </td>
                                <td>
                                    <select name="model[@i].SelectedMarks" class="marks-select" data-kra="@Model.KraKpiOutcomeData[i].KRA" data-outcome="@Model.KraKpiOutcomeData[i].Outcome">
                                        <option value="0" @(Model.KraKpiOutcomeData[i].Marks_Achieved == 0 ? "selected" : "")>0</option>
                                        <option value="1" @(Model.KraKpiOutcomeData[i].Marks_Achieved == 1 ? "selected" : "")>1</option>
                                        <option value="2" @(Model.KraKpiOutcomeData[i].Marks_Achieved == 2 ? "selected" : "")>2</option>
                                        <option value="3" @(Model.KraKpiOutcomeData[i].Marks_Achieved == 3 ? "selected" : "")>3</option>
                                        <option value="4" @(Model.KraKpiOutcomeData[i].Marks_Achieved == 4 ? "selected" : "")>4</option>
                                        <option value="5" @(Model.KraKpiOutcomeData[i].Marks_Achieved == 5 ? "selected" : "")>5</option>
                                    </select>
                                    <input type="hidden" name="model[@i].Outcome" value="@Model.KraKpiOutcomeData[i].Outcome" />
                                    <input type="hidden" name="model[@i].KPI_ID" value="@Model.KraKpiOutcomeData[i].KPI_ID" />
                                </td>
                                @if (j == 0)
                                {
                                    <td rowspan="@kraCount">
                                        <input type="text" class="average-input" value="@Model.KraKpiOutcomeData[i].AVG_Marks_Achieved" data-kra="@Model.KraKpiOutcomeData[i].KRA" data-outcome="@Model.KraKpiOutcomeData[i].Outcome" readonly />
                                    </td>
                                }
                            </tr>
                            i++;
                        }
                    }

                    <tr>
                        <td colspan="5" style="text-align: center; background-color: Highlight; color: white; height:30px;">
                            <strong>Average Cumulative Score of KRA’s</strong>
                        </td>
                        <td style="text-align: center; background-color: Highlight; color: white;">
                            <strong>@averageKpiAvg</strong>
                        </td>
                    </tr>
                </tbody>
            </table>
            <input type="submit" value="Save Marks" />
        }
    </div>
}
else
{
    <div class="alert alert-danger" role="alert">No data found!</div>
}

<br />
<br />

@using (Html.BeginForm("SaveReportSuperComment", "ReportSuper", new { regId = ViewBag.RegId }, FormMethod.Post, new { id = "reportSuperForm" }))
{
    <input type="hidden" id="regId" name="regId" value="@ViewBag.RegId" />

    @*@Html.HiddenFor(m => m[0].REG_ID)*@

    <div style="padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
        <label for="comment" style="font-weight: bold; color: #333;">Comment:</label><br>
        <input type="text" id="comment" name="comment" style="width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;">
        <br>
        <input type="submit" id="reportSuperForm" value="Submit & Lock" color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
    </div>
}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

@section scripts {
    <script>
        $(document).ready(function () {

            $("#revertEmployeeButton").click(function () {
                var regId = $(this).data("regid");

                $.ajax({
                    url: '@Url.Action("RevertEmployee", "ReportSuper")',
                    type: 'POST',
                    data: { regId: regId },
                    success: function (response) {
                        if (response.success) {
                            alert(response.message);
                            location.reload();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function () {
                        alert('An error occurred while reverting the approval!');
                    }
                });
            });

            var kraAverages = {};
            $(".marks-select").on("change", function () {
                var kra = $(this).data("kra");
                var outcome = $(this).data("outcome");
                var selectedValue = parseInt($(this).val());

                console.log("KRA:", kra);
                console.log("Outcome:", outcome);
                console.log("Selected Value:", selectedValue);

                calculateAverage(kra);
            });

            function calculateAverage(kra) {
                var totalMarks = 0;
                var rowCount = 0;

                $(".marks-select[data-kra='" + kra + "']").each(function () {
                    var marks = parseInt($(this).val());
                    if (!isNaN(marks)) {
                        totalMarks += marks;
                        rowCount++;
                    }
                });

                if (rowCount > 0) {
                    var average = totalMarks / rowCount;
                    console.log("Average for KRA " + kra + ": " + average.toFixed(2));

                    kraAverages[kra] = average;

                    $(".average-input[data-kra='" + kra + "']").val(average.toFixed(2));
                }
            }

        var successMessage = '@TempData["SuccessMessage"]';
        if (successMessage) {
            alert(successMessage);
        }
        });

        $(function() {
            $('#reportSuperForm').submit(function (event) {
                event.preventDefault();
                var formData = $(this).serialize();

                $.ajax({
                    url: '@Url.Action("SaveReportSuperComment", "ReportSuper")',
                    type: 'POST',
                    data: formData,
                    success: function (response) {

                        if (response.success) {
                            alert(response.message);
                        } else {
                            alert(response.message);
                        }
/*                        alert(JSON.stringify(response));*/
                    },
                    error: function() {
                        alert('An error occurred while saving the comment!');
                    }
                });
            });
        });

        // next year table toggle

        function toggleTableNY() {
            var tableContainer = document.getElementById("tableContainerNY");
            var toggleButton = document.getElementById("toggleButtonNY");
            if (tableContainer.style.display === "none") {
                tableContainer.style.display = "block";
                toggleButton.textContent = "Minimize Data";
            } else {
                tableContainer.style.display = "none";
                toggleButton.textContent = "View Next Year Data";
            }
        }
    </script>
}
