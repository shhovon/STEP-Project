
@model List<KraKpiOutcomeModel>

@{
    var firstItem = Model.FirstOrDefault();
}

@{
    var marksUpdateModel = new List<MarksUpdateModel>();
}

<head>
    <link rel="stylesheet" type="text/css" href="~/Content/css/CustomStyles.css">
</head>

<a href="@Url.Action("ViewEmpListHR", "HR")" class="btn btn-primary" style="text-decoration: none;">
    <span>Search Again</span>
</a>
<br />
<br />
<br />


@if (firstItem != null)
{
    <div>
        <p><strong>Employee Code: @firstItem.EmployeeCode</strong></p>
        <p><strong>Employee Name: @firstItem.Name</strong></p>
    </div>
}
<br />

@if (Model != null && Model.Count > 0)
{
    <div class="table-responsive">
        @using (Html.BeginForm("UpdateMarks", "ReportSuper", FormMethod.Post))
        {
            @Html.Hidden("regId", null, new { id = "viewregIDField" })

            @Html.HiddenFor(m => m[0].REG_ID)
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>KRA</th>
                        <th>KPI</th>
                        <th>Outcome</th>
                        <th>Performance Marks</th>
                        <th>Average</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.Count;)
                    {
                        var kra = Model[i].KRA;
                        var kraCount = Model.Count(m => m.KRA == kra);
                        for (int j = 0; j < kraCount; j++)
                        {
                            var marksModel = new MarksUpdateModel
                            {
                                Outcome = Model[i].Outcome,
                                Marks = 0
                            };
                            marksUpdateModel.Add(marksModel);

                            <tr>
                                @if (j == 0)
                                {
                                    <td rowspan="@kraCount">@Model[i].KRA</td>
                                }
                                <td>@Model[i].KPI</td>
                                <td>@Model[i].Outcome</td>
                                <td>
                                    <select name="@("marksUpdateModel[" + (marksUpdateModel.Count - 1) + "].Marks")" class="marks-select" data-kra="@Model[i].KRA" data-outcome="@Model[i].Outcome">
                                        @if (@Model[i].Marks_Achieved == 0)
                                        {
                                            <option value="0" selected>0</option>
                                        }
                                        else
                                        {
                                            <option value="0">0</option>
                                        }


                                        @if (@Model[i].Marks_Achieved == 1)
                                        {
                                            <option value="1" selected>1</option>
                                        }
                                        else
                                        {
                                            <option value="1">1</option>
                                        }

                                        @if (@Model[i].Marks_Achieved == 2)
                                        {
                                            <option value="2" selected>2</option>
                                        }

                                        else
                                        {
                                            <option value="2">2</option>
                                        }

                                        @if (@Model[i].Marks_Achieved == 3)
                                        {
                                            <option value="3" selected>3</option>
                                        }

                                        else
                                        {
                                            <option value="3">3</option>
                                        }

                                        @if (@Model[i].Marks_Achieved == 4)
                                        {
                                            <option value="4" selected>4</option>
                                        }

                                        else
                                        {
                                            <option value="4">4</option>
                                        }

                                        @if (@Model[i].Marks_Achieved == 5)
                                        {
                                            <option value="5" selected>5</option>
                                        }

                                        else
                                        {
                                            <option value="5">5</option>
                                        }

                                    </select>
                                    <input type="hidden" name="@("marksUpdateModel[" + i + "].Outcome")" value="@Model[i].Outcome" />
                                </td>
                                @if (j == 0)
                                {
                                    <td rowspan="@kraCount">
                                        <input type="text" class="average-input" value="@Model[i].AVG_Marks_Achieved" data-kra="@Model[i].KRA" data-outcome="@Model[i].Outcome" readonly />
                                    </td>
                                }
                            </tr>
                            i++;
                        }
                    }
                </tbody>
            </table>
            <input type="submit" value="Update Marks" />
        }
    </div>
}
else
{
    <div class="alert alert-danger" role="alert">
        No data found!
    </div>
}

<br />
<br />

<table border="1" style="width: 100%; border-collapse: collapse;">
@*    <tr>
        <th colspan="3" style="text-align: left; background-color: #f2f2f2; padding: 10px;">Rating Scale</th>
    </tr>*@
    <tr>
        <td style="width: 30%; padding: 10px; font-weight: bold; vertical-align: middle;">1. Attendance</td>
        <td style="width: 10%; padding: 10px; vertical-align: top;">
            <form id="attendanceForm" action="@Url.Action("SaveAttendance", "HR")" method="post">
                @Html.Hidden("regId", firstItem.REG_ID)
                <label for="attendance" style="font-weight: bold; color: #333;"></label><br>
                <select id="attendance" name="attendance" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 14px;">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
                <br>
                <input type="submit" value="Save" style="background-color: #007bff; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">
            </form>
        </td>
        <td style="padding: 10px;">
            <ul style="list-style-type: none; margin: 0; padding: 0;">
                <li>5 = No late for work or absence record during the appraisal period.</li>
                <li>4 = 1 time or less of late work or 1/2 times or less of early leave (1/2 day) during the appraisal period.</li>
                <li>3 = 2 times or more of late work or 1 time or more of early leave (1/2 day) during the appraisal period.</li>
                <li>2 = 3 times or more of absence record during the appraisal period or more than 24 times late at work or more than 24 times of early leave (1/2day) during the appraisal period.</li>
                <li>1 = Habitual late, absence & early leave (As per job card during the appraisal period).</li>
            </ul>
        </td>
    </tr>
    <tr>
        <td style="padding: 10px; font-weight: bold; vertical-align: middle;">2. Discipline</td>
        <td style="padding: 10px; vertical-align: top;">
            <form id="disciplineForm" action="@Url.Action("SaveDiscipline", "HR")" method="post">
                @Html.Hidden("regId", firstItem.REG_ID)
                <label for="discipline" style="font-weight: bold; color: #333;"></label><br>
                <select id="discipline"  name="discipline" style="width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 14px;">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
                <br>
                <input type="submit" value="Save" style="background-color: #007bff; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer;">
            </form>
        </td>
        <td style="padding: 10px;">
            <ul style="list-style-type: none; margin: 0; padding: 0;">
                <li>5 = Follows supervisor/always follow supervisor's all instructions.</li>
                <li>4 = Verbal warning.</li>
                <li>3 = Written warning.</li>
                <li>2 = Written warning with suspension.</li>
                <li>1 = Termination.</li>
            </ul>
        </td>
    </tr>
</table>








@*<div style="padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">

    </div>*@


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

@section scripts {
    <script>
        $(document).ready(function () {
            var kraAverages = {};
            $(".marks-select").on("change", function () {
                var kra = $(this).data("kra");
                var outcome = $(this).data("outcome");
                var selectedValue = parseInt($(this).val());

                console.log("KRA:", kra);
                console.log("Outcome:", outcome);
                console.log("Selected Value:", selectedValue);

                calculateAverage(kra);
            });

            function calculateAverage(kra) {
                var totalMarks = 0;
                var rowCount = 0;

                $(".marks-select[data-kra='" + kra + "']").each(function () {
                    var marks = parseInt($(this).val());
                    if (!isNaN(marks)) {
                        totalMarks += marks;
                        rowCount++;
                    }
                });

                if (rowCount > 0) {
                    var average = totalMarks / rowCount;
                    console.log("Average for KRA " + kra + ": " + average.toFixed(2));

                    kraAverages[kra] = average;

                    $(".average-input[data-kra='" + kra + "']").val(average.toFixed(2));
                }
            }
@*
        var successMessage = '@TempData["SuccessMessage"]';
        if (successMessage) {
            alert(successMessage);
        }
        });*@

        $(document).ready(function () {
        var successMessage = '@TempData["SuccessMessage"]';
        if (successMessage) {
            alert(successMessage);
        }
    });

        // filter data function
        $(function () {
            $('#taxPeriodDropdownMV').change(function () {
                var selectedSession = $(this).val();

                $.ajax({
                    url: '@Url.Action("GetFilteredMarksData", "Home")',
                    type: 'GET',
                    data: { selectedSession: selectedSession },
                    success: function (response) {
                        $('tbody').empty();

                        response.forEach(function (item) {
                            var newRow = '<tr>' +
                                '<td>' + item.KPI_OUTCOME + '</td>' +
                                '<td>' + item.Marks_Achieved + '</td>' +
                                '<td></td>' +
                                '</tr>';

                            $('tbody').append(newRow);
                        });

                        if (response.length > 0) {
                            $('table thead').show();
                        } else {
                            $('table thead').hide();
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                    }
                });
            });
        });
    </script>
}


