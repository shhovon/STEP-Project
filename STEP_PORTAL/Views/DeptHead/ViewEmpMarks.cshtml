@model DisplayAllDataViewModel


<head>
    <link rel="stylesheet" type="text/css" href="~/Content/css/CustomStyles.css">
</head>

<body>

    <h3>View Employee Marks and Report Supervisor Comment</h3>
    <br />

    @if (!string.IsNullOrEmpty(ViewBag.ErrorMessage))
    {
        <script>alert('@ViewBag.ErrorMessage');</script>
    }

    <style>
        .tab {
            display: inline-block;
            margin-left: 40px;
        }

        .tab2 {
            display: inline-block;
            margin-left: 45px;
        }
    </style>

    <br />
    <div>
        <p><strong>Employee Code: <span class="tab2"></span> @Session["EmployeeCodeInd"]</strong></p>
        <p><strong>Employee Name: <span class="tab"></span> @Session["NameInd"]</strong></p>
    </div>
    <br />

    @if (Model != null && Model.KraKpiOutcomeData.Count > 0)
    {
        <div>
            <table class="user-info-table">
                <thead>
                    <tr>
                        <th>KRA</th>
                        <th>KPI</th>
                        <th>Outcome</th>
                        <th>Performance Marks</th>
                        <th>Total Average</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.GroupedData)
                    {
                        var kpiCount = item.KPIIs.Count;
                        for (var i = 0; i < kpiCount; i++)
                        {
                            var kpi = item.KPIIs[i];
                            var outcomeItem = Model.KraKpiOutcomeData.FirstOrDefault(m => m.KRA == item.KRA && m.KPI == kpi);
                            string outcome = outcomeItem != null ? outcomeItem.Outcome : null;
                            var mark = outcomeItem != null ? outcomeItem.Marks_Achieved : 0;

                            <tr>
                                @if (i == 0)
                                {
                                    <td rowspan=@kpiCount>@item.KRA</td>
                                }
                                <td>@kpi</td>
                                <td>@outcome</td>
                                <td style="text-align:center">@mark</td>
                                @if (i == 0)
                                {
                                    <td rowspan=@kpiCount style="text-align:center">
                                        @(Model.KraKpiOutcomeData.Where(m => m.KRA == item.KRA).Sum(m => m.AVG_Marks_Achieved) / item.KPIIs.Count)
                                    </td>
                                }
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <p>No marks data available</p>
    }


    <br /><br />
    <div style="padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
        <label for="comment" style="font-weight: bold; color: #333;">Supervisor's Comment:</label><br>
        <input type="text" disabled id="SupervisorComment" name="SupervisorComment" value="@Model.SupervisorComment" style="width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;">
        <br>
    </div>
    <br />

    <div style="padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
        <label for="comment" style="font-weight: bold; color: #333;">User's Comment:</label><br>
        <input type="text" disabled id="UserComment" name="UserComment" value="@Model.UserComment" style="width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;">
        <br>
    </div>
    <br />

    @using (Html.BeginForm("SaveHODComment", "ReportSuper", FormMethod.Post))
    {
        @Html.Hidden("regId", null, new { id = "viewregIDField" })

        @* @Html.HiddenFor(m => m[0].REG_ID)*@

        <div style="padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
            <label for="comment" style="font-weight: bold; color: #333;">HOD Comment:</label><br>
            <input type="text" id="HODComment" name="comment" style="width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;">
            <br>
            <label for="comment" style="font-weight: bold; color: #333;">Promote as:</label><br>
            <input type="text" id="HODComment" name="comment" style="width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;">
            <br>
            <label for="comment" style="font-weight: bold; color: #333;">Proceed with annual increment of BDT:</label><br>
            <input type="number" id="HODComment" name="comment" style="width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;">
            <br>
            <input type="submit" value="Submit" color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
        </div>
    }

</body>

@section scripts {
    <script>
        $(function () {
            $('#taxPeriodDropdownMV').change(function () {
                var selectedSession = $(this).val();
                console.log(selectedSession);

                $.ajax({
                    url: '@Url.Action("GetFilteredMarksData", "Home")',
                    type: 'GET',
                    data: { selectedSession: selectedSession },
                    success: function (response) {
                        $('tbody').empty();
                        var totalMarks = 0;
                        var count = 0;

                        response.forEach(function (item) {
                            var newRow = '<tr>' +
                                '<td>' + item.KPI_OUTCOME + '</td>' +
                                '<td>' + item.Marks_Achieved + '</td>' +
                                '<td></td>' +
                                '</tr>';

                            totalMarks += item.Marks_Achieved;
                            console.log(totalMarks);
                            count++;
                            $('tbody').append(newRow);
                        });

                        var average = totalMarks / count;
                        $('#averageMarks').text(average.toFixed(2));
                        console.log(average);
                        $('tfoot td:nth-child(3)').text(average.toFixed(2));
                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                    }
                });
            });
        });

        $.ajax({
        url: '@Url.Action("GetReportSuperComment", "ReportSuper")',
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            $('#comment').val(data.SupervisorComment);
        },
        error: function() {
            console.error('Error fetching supervisor comment!');
        }
        });

        $(function() {
            $('form').submit(function(event) {
                event.preventDefault();

                var formData = $(this).serialize();

                $.ajax({
                    url: '@Url.Action("SaveHODComment", "DeptHead")',
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function() {
                        alert('An error occurred while saving the comment!');
                    }
                });
            });
            });

    </script>
}

